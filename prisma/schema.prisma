datasource db {
  provider = "postgresql"
  url = env("POSTGRES_PRISMA_URL") // uses connection pooling
  directUrl = env("POSTGRES_URL_NON_POOLING") // uses a direct connection
}

generator client {
  provider   = "prisma-client-js"
  engineType = "library"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

model User {
  id       String  @id @default(cuid())
  email    String  @unique
  password String? // For credentials auth
  role     String  @default("USER") // ADMIM, USER

  // Identity Info
  firstName    String?
  lastName     String?
  birthYear    Int?
  tcIdentityNo String? @unique

  // Academic Info
  university    String?
  programLevel  String? // "Ön Lisans", "Lisans", "Yüksek Lisans", "Doktora"
  faculty       String?
  department    String?
  studentClass  String?
  studentNumber String? @unique

  // Consents
  marketingConsent Boolean @default(false)

  lastApprovedUploadAt DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  notes                Note[]
  comments             Comment[]
  likes                Like[]
  views                View[]
  credits              Int       @default(3) // Süt Bakiyesi (Başlangıç 3 Süt)
  unlockedNotes        UnlockedNote[]
  purchases            ProductPurchase[]
}

model UnlockedNote {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  noteId    String
  note      Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, noteId])
}

model University {
  id        String    @id @default(cuid())
  name      String    @unique
  isActive  Boolean   @default(true)
  faculties Faculty[]
}

model Faculty {
  id           String       @id @default(cuid())
  name         String
  universityId String
  university   University   @relation(fields: [universityId], references: [id])
  departments  Department[]
}

model Department {
  id        String  @id @default(cuid())
  name      String
  facultyId String
  faculty   Faculty @relation(fields: [facultyId], references: [id])
}

model Note {
  id         String @id @default(cuid())
  title      String
  university String
  faculty    String
  department String
  fileUrl    String
  price      Int    @default(1) // Notun Süt değeri (1-3)
  status     String @default("PENDING") // PENDING, APPROVED, REJECTED

  // Metadata
  courseName  String?
  type        String? // Ders Notu, İmdat Sorular, etc.
  term        String? // 2025 Güz, etc.
  description String? // User description
  viewCount   Int     @default(0)

  uploaderId String
  uploader   User     @relation(fields: [uploaderId], references: [id])
  
  comments   Comment[]
  likes      Like[]
  views      View[]
  unlockedBy UnlockedNote[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Comment {
  id        String   @id @default(cuid())
  text      String
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  noteId    String
  note      Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model Like {
  id        String   @id @default(cuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  noteId    String
  note      Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, noteId]) // Bir kullanıcı bir notu sadece bir kez beğenebilir
}

model View {
  id        String   @id @default(cuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  noteId    String
  note      Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, noteId]) // Bir kullanıcı bir notu (teorik olarak) bir kez "izledi" sayılır
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Int      @default(0) // Süt fiyatı
  imageUrl    String?
  isActive    Boolean  @default(true)
  stock       Int?     // null = sınırsız

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  purchases   ProductPurchase[]
}

model ProductPurchase {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  priceAtTime Int    // Satın alma anındaki fiyat

  createdAt DateTime @default(now())
}
